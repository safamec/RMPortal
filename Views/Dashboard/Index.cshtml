@model RMPortal.Models.DashboardViewModel
@{
    ViewData["Title"] = "Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…";
}

<!-- âœ… Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø¯ÙŠØ¯ -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show text-center" role="alert">
        <strong>âœ… Ù†Ø¬Ø§Ø­:</strong> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <script>
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ 4 Ø«ÙˆØ§Ù†Ù
        setTimeout(() => {
            document.querySelector('.alert')?.classList.remove('show');
        }, 4000);
    </script>
}

<div class="container mt-5">

    <!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª -->
    <div class="row text-center mb-4">
        <div class="col-md-4">
            <div class="p-4 bg-secondary text-white rounded">
                <h3>@Model.PendingCount</h3>
                <p>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªÙŠ ØªØ­Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="p-4 bg-secondary text-white rounded">
                <h3>@Model.ApprovedCount</h3>
                <p>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ø·Ø§Ø©</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="p-4 bg-secondary text-white rounded">
                <h3>@Model.ExpiredCount</h3>
                <p>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©</p>
            </div>
        </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
    <div class="mb-4">
        <input type="text" class="form-control mb-3" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ¸Ù Ø£Ùˆ Ù‚Ø³Ù…..." />
        <table class="table table-bordered text-center align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
                    <th>Ø§Ù„Ù‚Ø³Ù…</th>
                    <th>Ù…Ø¯Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
                    <th>Ù†ÙˆØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
                    <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                    <th>Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th>
                    <th>ØªÙ…Ø¯ÙŠØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var req in Model.RecentRequests)
            {
                var now = DateTime.UtcNow;
                var remainingDays = req.EndDate.HasValue ? (req.EndDate.Value - now).Days : (int?)null;
                var isActive = req.EndDate.HasValue && req.EndDate.Value >= now;

                <tr>
                    <td>@req.Name</td>
                    <td>@req.Department</td>
                    <td>@(req.StartDate?.ToString("yyyy/MM/dd") ?? "-") - @(req.EndDate?.ToString("yyyy/MM/dd") ?? "-")</td>
                    <td>@req.Classification</td>

                    <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ -->
                    <td class="@(isActive ? "text-success fw-bold" : "text-danger fw-bold")">
                        @(isActive ? "Ù†Ø´Ø·" : "ØºÙŠØ± Ù†Ø´Ø·")
                    </td>

                    <!-- Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© -->
                    <td>
                        @(remainingDays.HasValue ? $"{remainingDays} ÙŠÙˆÙ…" : "-")
                    </td>

                    <!-- Ø²Ø± Ø§Ù„ØªÙ…Ø¯ÙŠØ¯ -->
                    <td>
                        <form asp-action="Extend" asp-controller="Dashboard" method="post" style="display:inline;">
                            <input type="hidden" name="id" value="@req.Id" />
                            <input type="number" name="months" min="1" max="12" value="1"
                                   class="form-control d-inline-block text-center"
                                   style="width:70px; display:inline;" />
                            <button type="submit" class="btn btn-sm btn-primary ms-2">ØªÙ…Ø¯ÙŠØ¯</button>
                        </form>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>

    <!-- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
    <div class="row mt-5 text-center">
        <div class="col-md-4">
            <canvas id="requestsChart"></canvas>
            <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„ÙƒÙ„ Ù‚Ø³Ù…</p>
        </div>
        <div class="col-md-4">
            <canvas id="rejectedChart"></canvas>
            <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø©</p>
        </div>
        <div class="col-md-4">
            <canvas id="yearlyChart"></canvas>
            <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø®Ù„Ø§Ù„ Ø§Ù„Ø³Ù†Ø©</p>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const deptLabels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.RequestsByDepartment.Select(x => x.Department)));
        const deptCounts = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.RequestsByDepartment.Select(x => x.Count)));

        const rejectedLabels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.RejectedByDepartment.Select(x => x.Department)));
        const rejectedCounts = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.RejectedByDepartment.Select(x => x.Count)));

        new Chart(document.getElementById('requestsChart'), {
            type: 'bar',
            data: {
                labels: deptLabels,
                datasets: [{ label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª', data: deptCounts, backgroundColor: '#444' }]
            }
        });

        new Chart(document.getElementById('rejectedChart'), {
            type: 'bar',
            data: {
                labels: rejectedLabels,
                datasets: [{ label: 'Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø©', data: rejectedCounts, backgroundColor: '#880000' }]
            }
        });

        new Chart(document.getElementById('yearlyChart'), {
            type: 'line',
            data: {
                labels: ['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'],
                datasets: [{
                    label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª',
                    data: [3,5,8,6,10,7,12,9,11,8,6,10],
                    borderColor: '#000', fill: false, tension: 0.3
                }]
            }
        });
    </script>
}